<div class="p-3 sm:p-4 md:p-6 space-y-3 sm:space-y-4 md:space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div class="flex items-center gap-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold">Volume Management</h1>
        <p class="text-xs sm:text-sm text-zinc-400 hidden sm:block">Manage storage volumes across systems</p>
      </div>
      <!-- Compact colored stats -->
      <div class="flex items-center gap-2 text-sm">
        <span class="text-green-500 font-medium" title="Mounted">{{ volumeState.stats().mounted }}</span>
        <span class="text-zinc-600">/</span>
        <span class="text-orange-500 font-medium" title="Orphaned">{{ volumeState.stats().orphaned }}</span>
      </div>
    </div>

    <div class="flex items-center gap-2 sm:gap-3">
      <!-- Mobile Filter Sheet Trigger -->
      <button
        (click)="showMobileFilters.set(true)"
        class="md:hidden p-2.5 rounded-lg border border-zinc-700 hover:bg-zinc-800 transition-colors"
        title="Filters"
      >
        <lucide-icon [img]="SlidersHorizontal" class="w-4 h-4"></lucide-icon>
      </button>

      <!-- Create Volume Button -->
      <button
        (click)="showCreateDialog = true"
        class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 transition-colors text-sm"
      >
        <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon>
        <span class="hidden sm:inline">Create Volume</span>
      </button>

      <!-- Refresh -->
      <button
        (click)="refresh()"
        class="flex items-center p-2.5 sm:px-3 sm:py-1.5 rounded-lg border border-zinc-700 text-sm hover:bg-zinc-800 transition-colors"
        [disabled]="refreshing"
        title="Refresh"
      >
        <lucide-icon
          [img]="RefreshCw"
          class="w-4 h-4"
          [class.animate-spin]="refreshing"
        ></lucide-icon>
        <span class="hidden sm:inline ml-2">Refresh</span>
      </button>
    </div>
  </div>

  <!-- Search and Filters Bar -->
  <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
    <!-- Search -->
    <div class="relative flex-1 sm:max-w-xs">
      <lucide-icon
        [img]="Search"
        class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"
      ></lucide-icon>
      <input
        type="text"
        placeholder="Search volumes..."
        [ngModel]="volumeState.searchQuery()"
        (ngModelChange)="volumeState.setSearchQuery($event)"
        class="w-full h-9 pl-10 pr-4 bg-zinc-800 border border-zinc-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
      />
    </div>

    <!-- Desktop Filters -->
    <div class="hidden md:flex items-center gap-2">
      <!-- Mount filter with counts -->
      <select
        [ngModel]="volumeState.mountFilter()"
        (ngModelChange)="volumeState.setMountFilter($event)"
        class="h-9 px-3 bg-zinc-800 border border-zinc-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option value="all">All ({{ volumeState.stats().total }})</option>
        <option value="mounted">Mounted ({{ volumeState.stats().mounted }})</option>
        <option value="orphaned">Orphaned ({{ volumeState.stats().orphaned }})</option>
      </select>

      <!-- System filter -->
      <select
        [ngModel]="volumeState.systemFilter()"
        (ngModelChange)="volumeState.setSystemFilter($event)"
        class="h-9 px-3 bg-zinc-800 border border-zinc-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option [ngValue]="null">All Systems</option>
        @for (system of systemState.connectedSystems(); track system.id) {
          <option [ngValue]="system.id">{{ system.name }}</option>
        }
      </select>

      <!-- Runtime filter -->
      <select
        [ngModel]="volumeState.runtimeFilter()"
        (ngModelChange)="volumeState.setRuntimeFilter($event)"
        class="h-9 px-3 bg-zinc-800 border border-zinc-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option [ngValue]="null">All Runtimes</option>
        <option value="docker">Docker</option>
        <option value="podman">Podman</option>
        <option value="apple">Apple</option>
      </select>

      <!-- Sort -->
      <select
        [ngModel]="volumeState.sortOption()"
        (ngModelChange)="volumeState.setSortOption($event)"
        class="h-9 px-3 bg-zinc-800 border border-zinc-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option value="name">Sort: Name</option>
        <option value="driver">Sort: Driver</option>
        <option value="created">Sort: Created</option>
      </select>
    </div>
  </div>

  <!-- System Sections with Volumes -->
  <div class="space-y-6">
    @for (system of systemState.connectedSystems(); track system.id) {
      @if ((filteredVolumesBySystem()[system.id]?.length ?? 0) > 0 || volumeState.mountFilter() === 'all') {
        <app-system-volume-section
          [system]="system"
          [volumes]="filteredVolumesBySystem()[system.id] || []"
          (volumeDeleted)="onVolumeDeleted($event)"
        />
      }
    } @empty {
      <div class="text-center py-12 text-zinc-500">
        @if (systemState.connectedSystems().length === 0) {
          <p>No systems connected. Go to Systems to connect.</p>
        } @else {
          <p>No volumes match your filters.</p>
        }
      </div>
    }
  </div>
</div>

<!-- Mobile Filter Sheet -->
@if (showMobileFilters()) {
  <div class="fixed inset-0 bg-black/50 z-50 md:hidden" (click)="showMobileFilters.set(false)">
    <div
      class="absolute bottom-0 left-0 right-0 bg-zinc-900 rounded-t-2xl p-6 space-y-4 max-h-[80vh] overflow-y-auto"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Filters</h3>
        <button
          (click)="showMobileFilters.set(false)"
          class="p-2 rounded-lg hover:bg-zinc-800"
        >
          âœ•
        </button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-sm text-zinc-400 mb-2">System</label>
          <select
            [ngModel]="volumeState.systemFilter()"
            (ngModelChange)="volumeState.setSystemFilter($event)"
            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg"
          >
            <option [ngValue]="null">All Systems</option>
            @for (system of systemState.connectedSystems(); track system.id) {
              <option [ngValue]="system.id">{{ system.name }}</option>
            }
          </select>
        </div>

        <div>
          <label class="block text-sm text-zinc-400 mb-2">Runtime</label>
          <select
            [ngModel]="volumeState.runtimeFilter()"
            (ngModelChange)="volumeState.setRuntimeFilter($event)"
            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg"
          >
            <option [ngValue]="null">All Runtimes</option>
            <option value="docker">Docker</option>
            <option value="podman">Podman</option>
            <option value="apple">Apple</option>
          </select>
        </div>

        <div>
          <label class="block text-sm text-zinc-400 mb-2">Sort By</label>
          <select
            [ngModel]="volumeState.sortOption()"
            (ngModelChange)="volumeState.setSortOption($event)"
            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg"
          >
            <option value="name">Name</option>
            <option value="driver">Driver</option>
            <option value="created">Created</option>
          </select>
        </div>
      </div>

      <button
        (click)="showMobileFilters.set(false)"
        class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium transition-colors"
      >
        Apply Filters
      </button>
    </div>
  </div>
}

<!-- Create Volume Dialog -->
@if (showCreateDialog) {
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-zinc-900 rounded-lg p-6 w-full max-w-md space-y-4">
      <h2 class="text-xl font-bold">Create Volume</h2>

      <div class="space-y-3">
        <div>
          <label class="block text-sm text-zinc-400 mb-1">Volume Name</label>
          <input
            type="text"
            [(ngModel)]="createForm.name"
            placeholder="my-volume"
            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg"
          />
        </div>
        <div>
          <label class="block text-sm text-zinc-400 mb-1">System</label>
          <select
            [(ngModel)]="createForm.systemId"
            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg"
          >
            @for (system of systemState.connectedSystems(); track system.id) {
              <option [value]="system.id">{{ system.name }}</option>
            }
          </select>
        </div>
        <div>
          <label class="block text-sm text-zinc-400 mb-1">Runtime</label>
          <select
            [(ngModel)]="createForm.runtime"
            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg"
          >
            <option value="docker">Docker</option>
            <option value="podman">Podman</option>
            <option value="apple">Apple</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-zinc-400 mb-1">Driver (optional)</label>
          <input
            type="text"
            [(ngModel)]="createForm.driver"
            placeholder="local"
            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg"
          />
        </div>
      </div>

      <div class="flex justify-end gap-2">
        <button
          (click)="showCreateDialog = false"
          class="px-4 py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700"
        >
          Cancel
        </button>
        <button
          (click)="createVolume()"
          class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500"
          [disabled]="!createForm.name || !createForm.systemId"
        >
          Create
        </button>
      </div>
    </div>
  </div>
}
