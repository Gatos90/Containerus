<div class="p-3 sm:p-4 md:p-6 space-y-3 sm:space-y-4 md:space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div class="flex items-center gap-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold">System Management</h1>
        <p class="text-xs sm:text-sm text-zinc-400 hidden sm:block">Manage connected container systems</p>
      </div>
      <!-- Compact colored stats -->
      <div class="flex items-center gap-2 text-sm">
        <span class="text-green-500 font-medium" title="Connected">{{ systemState.stats().connected }}</span>
        <span class="text-zinc-600">/</span>
        <span class="text-zinc-500 font-medium" title="Disconnected">{{ systemState.stats().disconnected }}</span>
        @if (systemState.stats().error > 0) {
          <span class="text-zinc-600">/</span>
          <span class="text-red-500 font-medium" title="Error">{{ systemState.stats().error }}</span>
        }
      </div>
    </div>

    <div class="flex items-center gap-2 sm:gap-3">
      <!-- Add System Button -->
      <button
        (click)="showAddDialog = true"
        class="flex items-center justify-center gap-2 px-3 py-2.5 sm:py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 transition-colors text-sm touch-target"
      >
        <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon>
        <span class="hidden sm:inline">Add System</span>
      </button>

      <!-- Refresh Button -->
      <button
        (click)="refresh()"
        class="flex items-center p-2.5 sm:px-3 sm:py-1.5 rounded-lg border border-zinc-700 text-sm hover:bg-zinc-800 transition-colors"
        [disabled]="refreshing"
        title="Refresh"
      >
        <lucide-icon
          [img]="RefreshCw"
          class="w-4 h-4"
          [class.animate-spin]="refreshing"
        ></lucide-icon>
        <span class="hidden sm:inline ml-2">Refresh</span>
      </button>
    </div>
  </div>

  <!-- Error Alert -->
  @if (systemState.error()) {
    <div class="bg-red-500/10 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg flex items-center justify-between">
      <span class="text-sm">{{ systemState.error() }}</span>
      <button (click)="systemState.clearError()" class="p-1 text-red-400 hover:text-red-300">
        <lucide-icon [img]="X" class="w-4 h-4"></lucide-icon>
      </button>
    </div>
  }

  <!-- Search and Filters Bar -->
  <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
    <!-- Search -->
    <div class="relative flex-1 sm:max-w-xs">
      <lucide-icon
        [img]="Search"
        class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"
      ></lucide-icon>
      <input
        type="text"
        placeholder="Search systems..."
        [ngModel]="systemState.searchQuery()"
        (ngModelChange)="systemState.setSearchQuery($event)"
        class="w-full h-9 pl-10 pr-4 bg-zinc-800 border border-zinc-700 rounded-lg text-sm placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
    </div>

    <!-- Desktop Filters -->
    <div class="hidden md:flex items-center gap-2">
      <!-- Status filter with counts -->
      <select
        [ngModel]="systemState.statusFilter()"
        (ngModelChange)="systemState.setStatusFilter($event)"
        class="h-9 px-3 bg-zinc-800 border border-zinc-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option [ngValue]="null">All ({{ systemState.stats().total }})</option>
        <option value="connected">Connected ({{ systemState.stats().connected }})</option>
        <option value="disconnected">Disconnected ({{ systemState.stats().disconnected }})</option>
        @if (systemState.stats().error > 0) {
          <option value="error">Error ({{ systemState.stats().error }})</option>
        }
      </select>
    </div>
  </div>

  <!-- System Cards -->
  <div class="space-y-3">
    @for (system of systemState.filteredSystems(); track system.id) {
      <div class="bg-zinc-800 rounded-lg p-3 sm:p-4 space-y-3">
        <!-- Mobile: Stack layout -->
        <div class="flex items-start sm:items-center gap-3 sm:gap-4">
          <lucide-icon [img]="Server" class="w-5 h-5 sm:w-6 sm:h-6 text-zinc-400 flex-shrink-0 mt-0.5 sm:mt-0"></lucide-icon>

          <div class="flex-1 min-w-0">
            <div class="font-medium flex items-center gap-2 flex-wrap">
              <span class="truncate">{{ system.name }}</span>
              <span
                class="w-2 h-2 rounded-full flex-shrink-0"
                [class.bg-green-500]="getConnectionState(system.id) === 'connected'"
                [class.bg-red-500]="getConnectionState(system.id) === 'error'"
                [class.bg-yellow-500]="getConnectionState(system.id) === 'connecting'"
                [class.bg-zinc-500]="getConnectionState(system.id) === 'disconnected'"
              ></span>
              <span class="text-xs px-1.5 py-0.5 rounded bg-zinc-700 text-zinc-400 sm:hidden">
                {{ system.primaryRuntime }}
              </span>
            </div>
            <div class="text-xs sm:text-sm text-zinc-400 truncate">
              {{ system.hostname }} ({{ system.connectionType }})
            </div>
          </div>

          <div class="text-sm text-zinc-500 hidden sm:block">
            {{ system.primaryRuntime }}
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-0.5 sm:gap-1 flex-shrink-0">
            @if (getConnectionState(system.id) === 'connected') {
              <button
                (click)="disconnect(system.id)"
                title="Disconnect"
                class="p-2.5 sm:p-2 touch-target rounded-lg hover:bg-zinc-700 transition-colors"
              >
                <lucide-icon [img]="Unlink" class="w-4 h-4"></lucide-icon>
              </button>

              <a
                [routerLink]="['/terminal', system.id]"
                title="Terminal"
                class="p-2.5 sm:p-2 touch-target rounded-lg hover:bg-zinc-700 transition-colors"
              >
                <lucide-icon [img]="Terminal" class="w-4 h-4"></lucide-icon>
              </a>
            } @else {
              <button
                (click)="connect(system.id)"
                title="Connect"
                class="p-2.5 sm:p-2 touch-target rounded-lg hover:bg-zinc-700 transition-colors"
                [disabled]="getConnectionState(system.id) === 'connecting'"
              >
                <lucide-icon [img]="Link" class="w-4 h-4"></lucide-icon>
              </button>
            }

            <button
              (click)="openEditDialog(system)"
              title="Edit"
              class="p-2.5 sm:p-2 touch-target rounded-lg hover:bg-zinc-700 transition-colors"
            >
              <lucide-icon [img]="Pencil" class="w-4 h-4"></lucide-icon>
            </button>

            <button
              (click)="deleteSystem(system.id)"
              title="Delete"
              class="p-2.5 sm:p-2 touch-target rounded-lg hover:bg-zinc-700 transition-colors text-red-400 hover:text-red-300"
            >
              <lucide-icon [img]="Trash2" class="w-4 h-4"></lucide-icon>
            </button>
          </div>
        </div>

        @if (getConnectionState(system.id) === 'connected') {
          @let info = getExtendedInfo(system.id);
          @let liveMetrics = getLiveMetrics(system.id);

          <!-- Extended System Info with Live Metrics -->
          @if (info) {
            <div class="p-3 bg-zinc-900/50 rounded-lg space-y-3">
              <!-- Quick Info Line: user · cores · memory · uptime -->
              <div class="flex items-center gap-2 text-xs text-zinc-400 flex-wrap">
                <!-- User with badges -->
                <span class="flex items-center gap-1">
                  {{ info.username }}
                  @if (info.isRoot) {
                    <lucide-icon [img]="Crown" class="w-3 h-3 text-amber-500" title="Root user"></lucide-icon>
                  }
                  @if (info.canSudo && !info.isRoot) {
                    <lucide-icon [img]="ShieldCheck" class="w-3 h-3 text-blue-400" title="Can sudo"></lucide-icon>
                  }
                </span>
                @if (info.cpuCount) {
                  <span class="text-zinc-600">·</span>
                  <span>{{ info.cpuCount }} cores</span>
                }
                @if (info.totalMemory) {
                  <span class="text-zinc-600">·</span>
                  <span>{{ info.totalMemory }}</span>
                }
                @if (info.uptime) {
                  <span class="text-zinc-600">·</span>
                  <span class="truncate" [title]="'up ' + info.uptime">up {{ info.uptime }}</span>
                }
              </div>

              <!-- Live Metrics with Aligned Rows -->
              @if (liveMetrics) {
                <div class="space-y-2">
                  <!-- CPU Row -->
                  <div class="flex items-center gap-2 sm:gap-3">
                    <span class="w-8 sm:w-10 text-xs text-zinc-500 shrink-0">CPU</span>
                    <div class="flex-1 min-w-0 h-2 bg-zinc-700 rounded-full overflow-hidden">
                      <div
                        class="h-full rounded-full transition-all duration-500"
                        [class.bg-blue-500]="liveMetrics.cpuUsagePercent < 70"
                        [class.bg-amber-500]="liveMetrics.cpuUsagePercent >= 70 && liveMetrics.cpuUsagePercent < 85"
                        [class.bg-red-500]="liveMetrics.cpuUsagePercent >= 85"
                        [style.width.%]="liveMetrics.cpuUsagePercent"
                      ></div>
                    </div>
                    <span
                      class="w-9 sm:w-10 text-right text-xs sm:text-sm font-medium shrink-0"
                      [class.text-zinc-300]="liveMetrics.cpuUsagePercent < 70"
                      [class.text-amber-500]="liveMetrics.cpuUsagePercent >= 70 && liveMetrics.cpuUsagePercent < 85"
                      [class.text-red-500]="liveMetrics.cpuUsagePercent >= 85"
                    >{{ liveMetrics.cpuUsagePercent | number:'1.0-0' }}%</span>
                    <span class="w-20 text-xs text-zinc-500 text-right hidden md:block shrink-0">
                      @if (info.cpuCount) {
                        ({{ info.cpuCount }} cores)
                      }
                    </span>
                  </div>

                  <!-- RAM Row -->
                  <div class="flex items-center gap-2 sm:gap-3">
                    <span class="w-8 sm:w-10 text-xs text-zinc-500 shrink-0">RAM</span>
                    <div class="flex-1 min-w-0 h-2 bg-zinc-700 rounded-full overflow-hidden">
                      <div
                        class="h-full rounded-full transition-all duration-500"
                        [class.bg-blue-500]="liveMetrics.memoryUsagePercent < 70"
                        [class.bg-amber-500]="liveMetrics.memoryUsagePercent >= 70 && liveMetrics.memoryUsagePercent < 85"
                        [class.bg-red-500]="liveMetrics.memoryUsagePercent >= 85"
                        [style.width.%]="liveMetrics.memoryUsagePercent"
                      ></div>
                    </div>
                    <span
                      class="w-9 sm:w-10 text-right text-xs sm:text-sm font-medium shrink-0"
                      [class.text-zinc-300]="liveMetrics.memoryUsagePercent < 70"
                      [class.text-amber-500]="liveMetrics.memoryUsagePercent >= 70 && liveMetrics.memoryUsagePercent < 85"
                      [class.text-red-500]="liveMetrics.memoryUsagePercent >= 85"
                    >{{ liveMetrics.memoryUsagePercent | number:'1.0-0' }}%</span>
                    <span class="w-20 text-xs text-zinc-500 text-right hidden md:block shrink-0">
                      @if (liveMetrics.memoryUsed && liveMetrics.memoryTotal) {
                        {{ liveMetrics.memoryUsed }}/{{ liveMetrics.memoryTotal }}
                      }
                    </span>
                  </div>

                  <!-- Disk Row -->
                  @if (info.diskUsagePercent !== null && info.diskUsagePercent !== undefined) {
                    <div class="flex items-center gap-2 sm:gap-3">
                      <span class="w-8 sm:w-10 text-xs text-zinc-500 shrink-0">Disk</span>
                      <div class="flex-1 min-w-0 h-2 bg-zinc-700 rounded-full overflow-hidden">
                        <div
                          class="h-full rounded-full transition-all duration-500"
                          [class.bg-blue-500]="info.diskUsagePercent < 80"
                          [class.bg-amber-500]="info.diskUsagePercent >= 80 && info.diskUsagePercent < 90"
                          [class.bg-red-500]="info.diskUsagePercent >= 90"
                          [style.width.%]="info.diskUsagePercent"
                        ></div>
                      </div>
                      <span
                        class="w-9 sm:w-10 text-right text-xs sm:text-sm font-medium shrink-0"
                        [class.text-zinc-300]="info.diskUsagePercent < 80"
                        [class.text-amber-500]="info.diskUsagePercent >= 80 && info.diskUsagePercent < 90"
                        [class.text-red-500]="info.diskUsagePercent >= 90"
                      >{{ info.diskUsagePercent }}%</span>
                      <span class="w-20 hidden md:block shrink-0"></span>
                    </div>
                  }

                  <!-- Swap Row (if significant) -->
                  @if (liveMetrics.swapUsagePercent && liveMetrics.swapUsagePercent > 1) {
                    <div class="flex items-center gap-2 sm:gap-3">
                      <span class="w-8 sm:w-10 text-xs text-zinc-500 shrink-0">Swap</span>
                      <div class="flex-1 min-w-0 h-2 bg-zinc-700 rounded-full overflow-hidden">
                        <div
                          class="h-full rounded-full transition-all duration-500"
                          [class.bg-blue-500]="liveMetrics.swapUsagePercent < 50"
                          [class.bg-amber-500]="liveMetrics.swapUsagePercent >= 50 && liveMetrics.swapUsagePercent < 80"
                          [class.bg-red-500]="liveMetrics.swapUsagePercent >= 80"
                          [style.width.%]="liveMetrics.swapUsagePercent"
                        ></div>
                      </div>
                      <span
                        class="w-9 sm:w-10 text-right text-xs sm:text-sm font-medium shrink-0"
                        [class.text-zinc-300]="liveMetrics.swapUsagePercent < 50"
                        [class.text-amber-500]="liveMetrics.swapUsagePercent >= 50 && liveMetrics.swapUsagePercent < 80"
                        [class.text-red-500]="liveMetrics.swapUsagePercent >= 80"
                      >{{ liveMetrics.swapUsagePercent | number:'1.0-0' }}%</span>
                      <span class="w-20 hidden md:block shrink-0"></span>
                    </div>
                  }

                  <!-- Load Indicator Row (Composite Score) -->
                  @let loadLevel = getLoadLevel(liveMetrics);
                  <div class="flex items-center gap-2 sm:gap-3 flex-wrap" [title]="loadLevel.tooltip">
                    <span class="w-8 sm:w-10 text-xs text-zinc-500 shrink-0">Load</span>
                    <div class="flex items-center gap-0.5 shrink-0">
                      @for (i of loadDots; track i) {
                        <span
                          class="w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full"
                          [class]="i <= loadLevel.dots ? loadLevel.bgColor : 'bg-zinc-700'"
                        ></span>
                      }
                    </div>
                    <span class="text-xs shrink-0" [class]="loadLevel.color">{{ loadLevel.label }}</span>
                    <span class="text-xs text-zinc-500 shrink-0">({{ loadLevel.score }}%)</span>
                    <!-- Containers count inline -->
                    @if (info.runningContainers !== null && info.runningContainers !== undefined) {
                      <span class="ml-auto text-xs text-zinc-500 hidden md:block shrink-0">
                        <span class="text-green-500">{{ info.runningContainers }}</span>/<span class="text-zinc-500">{{ info.totalContainers ?? 0 }}</span> containers
                      </span>
                    }
                  </div>
                </div>
              } @else {
                <!-- Static info when no live metrics yet -->
                <div class="flex items-center gap-2 text-xs text-zinc-500">
                  <div class="w-4 h-4 border-2 border-zinc-600 border-t-zinc-400 rounded-full animate-spin"></div>
                  Loading live metrics...
                </div>
              }

              <!-- Container/Image stats for mobile (shown when no live metrics) -->
              @if (!liveMetrics && (info.runningContainers !== null && info.runningContainers !== undefined)) {
                <div class="flex items-center gap-3 text-xs">
                  <lucide-icon [img]="Box" class="w-4 h-4 text-zinc-500"></lucide-icon>
                  <span>
                    <span class="text-green-500">{{ info.runningContainers }}</span>/<span class="text-zinc-500">{{ info.totalContainers ?? 0 }}</span> containers
                  </span>
                  @if (info.totalImages !== null && info.totalImages !== undefined) {
                    <span class="text-zinc-600">·</span>
                    <span>{{ info.totalImages }} images</span>
                  }
                </div>
              }

              <!-- Hostname (if different from configured) -->
              @if (info.hostname && info.hostname !== system.hostname) {
                <div class="text-xs text-zinc-500">
                  Hostname: <span class="text-zinc-400">{{ info.hostname }}</span>
                </div>
              }
            </div>
          } @else {
            <!-- Loading state for extended info -->
            <div class="p-3 bg-zinc-900/50 rounded-lg">
              <div class="flex items-center gap-2 text-sm text-zinc-500">
                <div class="w-4 h-4 border-2 border-zinc-600 border-t-zinc-400 rounded-full animate-spin"></div>
                Loading system info...
              </div>
            </div>
          }

          <!-- Available Runtimes -->
          <div class="flex flex-wrap gap-1.5 sm:gap-2 text-xs">
            @for (runtime of system.availableRuntimes; track runtime) {
              <span class="px-2 py-0.5 rounded bg-zinc-700">{{ runtime }}</span>
            }
          </div>
        }
      </div>
    } @empty {
      <div class="text-center py-12 text-zinc-500">
        <lucide-icon [img]="Server" class="w-12 h-12 mx-auto mb-3 opacity-50"></lucide-icon>
        @if (systemState.searchQuery() || systemState.statusFilter()) {
          <p>No systems match your search.</p>
          <p class="text-sm mt-1">Try adjusting your filters or search query.</p>
          <button
            (click)="systemState.setSearchQuery(''); systemState.setStatusFilter(null)"
            class="mt-3 px-4 py-2 text-sm bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors"
          >
            Clear filters
          </button>
        } @else {
          <p>No systems configured.</p>
          <p class="text-sm mt-1">Tap "Add System" to get started.</p>
        }
      </div>
    }
  </div>
</div>

@if (showAddDialog) {
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black/70 z-50 flex items-end sm:items-center justify-center sm:p-4">
    <!-- Modal - full screen on mobile -->
    <div class="bg-zinc-900 w-full h-[100dvh] sm:h-auto sm:rounded-xl sm:max-w-lg sm:max-h-[90vh] flex flex-col overflow-hidden shadow-2xl">
      <!-- Header (fixed) -->
      <div class="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4 border-b border-zinc-800 flex-shrink-0">
        <h2 class="text-lg sm:text-xl font-bold">Add System</h2>
        <button
          (click)="showAddDialog = false"
          class="p-2.5 sm:p-2 touch-target text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 rounded-lg transition-colors"
        >
          <lucide-icon [img]="X" class="w-5 h-5"></lucide-icon>
        </button>
      </div>

      <!-- Scrollable content -->
      <div class="flex-1 min-h-0 overflow-auto p-4 sm:p-6">
        <!-- Error Alert inside dialog -->
        @if (systemState.error()) {
          <div class="bg-red-500/10 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg flex items-center justify-between mb-4">
            <span class="text-sm">{{ systemState.error() }}</span>
            <button (click)="systemState.clearError()" class="p-1 text-red-400 hover:text-red-300">
              <lucide-icon [img]="X" class="w-4 h-4"></lucide-icon>
            </button>
          </div>
        }

        <div class="space-y-4">
          <div>
            <label class="block text-sm text-zinc-400 mb-1.5">System Name</label>
            <input
              type="text"
              [(ngModel)]="addForm.name"
              placeholder="My Server"
              class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
            />
          </div>

          <div>
            <label class="block text-sm text-zinc-400 mb-1.5">Hostname / IP</label>
            <input
              type="text"
              [(ngModel)]="addForm.hostname"
              placeholder="localhost or 192.168.1.100"
              class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
            />
          </div>

          <div>
            <label class="block text-sm text-zinc-400 mb-1.5">Connection Type</label>
            <select
              [(ngModel)]="addForm.connectionType"
              class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
            >
              @if (!isMobile()) {
                <option value="local">Local</option>
              }
              <option value="remote">Remote (SSH)</option>
            </select>
          </div>

          @if (addForm.connectionType === 'remote') {
            <!-- SSH Host Selector (Desktop only) -->
            @if (!isMobile() && sshHosts().length > 0) {
              <div class="p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                <label class="block text-sm text-zinc-300 mb-1.5">
                  Import from SSH Config
                  <span class="text-zinc-500 text-xs ml-1">(~/.ssh/config)</span>
                </label>
                <select
                  [ngModel]="selectedSshHost"
                  (ngModelChange)="onSshHostSelected($event)"
                  class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                >
                  <option value="">-- Manual Configuration --</option>
                  @for (host of sshHosts(); track host.host) {
                    <option [value]="host.host">
                      {{ host.host }}@if (host.hostname && host.hostname !== host.host) { ({{ host.hostname }})}
                    </option>
                  }
                </select>
                @if (selectedSshHost) {
                  <p class="text-xs text-blue-400 mt-1.5 flex items-center gap-1">
                    <span>✓</span> Fields auto-filled from SSH config
                  </p>
                  @if (selectedHostProxyJump) {
                    <p class="text-xs text-amber-400 mt-1 flex items-center gap-1">
                      <span>↪</span> Connection via ProxyJump: {{ selectedHostProxyJump }}
                    </p>
                  }
                  @if (selectedHostProxyCommand) {
                    <p class="text-xs text-amber-400 mt-1 flex items-center gap-1">
                      <span>↪</span> Connection via ProxyCommand
                    </p>
                  }
                }
              </div>
            }

            <div class="space-y-4 p-4 bg-zinc-800/50 rounded-lg">
              <div>
                <label class="block text-sm text-zinc-400 mb-1.5">SSH Username</label>
                <input
                  type="text"
                  [(ngModel)]="addForm.sshUsername"
                  placeholder="root"
                  class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                />
              </div>

              <div>
                <label class="block text-sm text-zinc-400 mb-1.5">SSH Port</label>
                <input
                  type="number"
                  [(ngModel)]="addForm.sshPort"
                  placeholder="22"
                  class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                />
              </div>

              <div>
                <label class="block text-sm text-zinc-400 mb-1.5">Auth Method</label>
                <select
                  [(ngModel)]="addForm.sshAuthMethod"
                  class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                >
                  <option value="password">Password</option>
                  <option value="publicKey">Public Key</option>
                </select>
              </div>

              @if (addForm.sshAuthMethod === 'password') {
                <div>
                  <label class="block text-sm text-zinc-400 mb-1.5">Password</label>
                  <input
                    type="password"
                    [(ngModel)]="addForm.sshPassword"
                    placeholder="SSH Password"
                    class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                  />
                </div>
              }

              @if (addForm.sshAuthMethod === 'publicKey') {
                <!-- Import Method Toggle -->
                <div>
                  <label class="block text-sm text-zinc-400 mb-1.5">Import Method</label>
                  <div class="flex gap-2">
                    <button
                      type="button"
                      (click)="addForm.sshKeyImportMethod = 'paste'"
                      class="flex-1 px-3 py-2 rounded-lg text-sm transition-colors"
                      [class.bg-blue-600]="addForm.sshKeyImportMethod === 'paste'"
                      [class.bg-zinc-700]="addForm.sshKeyImportMethod !== 'paste'"
                      [class.hover:bg-zinc-600]="addForm.sshKeyImportMethod !== 'paste'"
                    >
                      Paste Key
                    </button>
                    <button
                      type="button"
                      (click)="addForm.sshKeyImportMethod = 'file'"
                      class="flex-1 px-3 py-2 rounded-lg text-sm transition-colors"
                      [class.bg-blue-600]="addForm.sshKeyImportMethod === 'file'"
                      [class.bg-zinc-700]="addForm.sshKeyImportMethod !== 'file'"
                      [class.hover:bg-zinc-600]="addForm.sshKeyImportMethod !== 'file'"
                    >
                      Import File
                    </button>
                  </div>
                </div>

                @if (addForm.sshKeyImportMethod === 'paste') {
                  <!-- Paste Key Content -->
                  <div>
                    <label class="block text-sm text-zinc-400 mb-1.5">Private Key Content</label>
                    <textarea
                      [(ngModel)]="addForm.sshKeyContent"
                      placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"
                      rows="6"
                      class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm font-mono text-xs resize-y"
                    ></textarea>
                    <p class="text-xs text-zinc-500 mt-1">Paste your private key in PEM format</p>
                  </div>
                } @else {
                  <!-- Import from File -->
                  <div>
                    <label class="block text-sm text-zinc-400 mb-1.5">Private Key File</label>
                    @if (isMobile()) {
                      <!-- Mobile: Import file content -->
                      <button
                        type="button"
                        (click)="importKeyFromFile('add')"
                        [disabled]="importingKey()"
                        class="w-full px-3 py-2.5 bg-zinc-700 hover:bg-zinc-600 border border-zinc-600 rounded-lg transition-colors flex items-center justify-center gap-2"
                      >
                        @if (importingKey()) {
                          <div class="w-4 h-4 border-2 border-zinc-400 border-t-white rounded-full animate-spin"></div>
                          <span>Importing...</span>
                        } @else {
                          <lucide-icon [img]="FolderOpen" class="w-4 h-4"></lucide-icon>
                          <span>Browse for Key File</span>
                        }
                      </button>
                      @if (addForm.sshKeyContent) {
                        <p class="text-xs text-green-500 mt-1 flex items-center gap-1">
                          <span>✓</span> Key imported successfully
                        </p>
                      }
                    } @else {
                      <!-- Desktop: File path or import -->
                      <div class="flex gap-2">
                        <input
                          type="text"
                          [(ngModel)]="addForm.sshKeyPath"
                          placeholder="~/.ssh/id_rsa"
                          class="flex-1 px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                        />
                        <button
                          type="button"
                          (click)="browseForSshKey('add')"
                          title="Browse for SSH key"
                          class="px-3 py-2.5 sm:py-2 bg-zinc-700 hover:bg-zinc-600 border border-zinc-600 rounded-lg transition-colors"
                        >
                          <lucide-icon [img]="FolderOpen" class="w-4 h-4"></lucide-icon>
                        </button>
                      </div>
                    }
                  </div>
                }

                <div>
                  <label class="block text-sm text-zinc-400 mb-1.5">Key Passphrase (optional)</label>
                  <input
                    type="password"
                    [(ngModel)]="addForm.sshKeyPassphrase"
                    placeholder="Leave empty if key has no passphrase"
                    class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                  />
                </div>
              }
            </div>
          }

          <div>
            <label class="block text-sm text-zinc-400 mb-1.5">Primary Runtime</label>
            <select
              [(ngModel)]="addForm.primaryRuntime"
              class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
            >
              <option value="docker">Docker</option>
              <option value="podman">Podman</option>
              <option value="apple">Apple Container</option>
            </select>
          </div>

          <div class="flex items-center gap-3 py-1">
            <input
              type="checkbox"
              id="autoConnect"
              [(ngModel)]="addForm.autoConnect"
              class="w-5 h-5 rounded border-zinc-700"
            />
            <label for="autoConnect" class="text-sm text-zinc-400"
              >Auto-connect on app startup</label
            >
          </div>
        </div>
      </div>

      <!-- Footer (fixed) -->
      <div class="flex justify-end gap-3 px-4 sm:px-6 py-3 sm:py-4 border-t border-zinc-800 flex-shrink-0 safe-bottom">
        <button
          (click)="showAddDialog = false"
          class="px-4 py-2.5 sm:py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 transition-colors text-sm"
          [disabled]="addingSystem()"
        >
          Cancel
        </button>
        <button
          (click)="addSystem()"
          class="px-4 py-2.5 sm:py-2 rounded-lg bg-blue-600 hover:bg-blue-500 transition-colors text-sm flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
          [disabled]="!addForm.name || !addForm.hostname || addingSystem()"
        >
          @if (addingSystem()) {
            <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
            <span>Adding...</span>
          } @else {
            <span>Add System</span>
          }
        </button>
      </div>
    </div>
  </div>
}

@if (showEditDialog) {
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black/70 z-50 flex items-end sm:items-center justify-center sm:p-4">
    <!-- Modal - full screen on mobile -->
    <div class="bg-zinc-900 w-full h-[100dvh] sm:h-auto sm:rounded-xl sm:max-w-lg sm:max-h-[90vh] flex flex-col overflow-hidden shadow-2xl">
      <!-- Header (fixed) -->
      <div class="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4 border-b border-zinc-800 flex-shrink-0">
        <h2 class="text-lg sm:text-xl font-bold">Edit System</h2>
        <button
          (click)="showEditDialog = false"
          class="p-2.5 sm:p-2 touch-target text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 rounded-lg transition-colors"
        >
          <lucide-icon [img]="X" class="w-5 h-5"></lucide-icon>
        </button>
      </div>

      <!-- Scrollable content -->
      <div class="flex-1 min-h-0 overflow-auto p-4 sm:p-6">
        <!-- Error Alert inside dialog -->
        @if (systemState.error()) {
          <div class="bg-red-500/10 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg flex items-center justify-between mb-4">
            <span class="text-sm">{{ systemState.error() }}</span>
            <button (click)="systemState.clearError()" class="p-1 text-red-400 hover:text-red-300">
              <lucide-icon [img]="X" class="w-4 h-4"></lucide-icon>
            </button>
          </div>
        }

        <div class="space-y-4">
          <div>
            <label class="block text-sm text-zinc-400 mb-1.5">System Name</label>
            <input
              type="text"
              [(ngModel)]="editForm.name"
              placeholder="My Server"
              class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
            />
          </div>

          <div>
            <label class="block text-sm text-zinc-400 mb-1.5">Hostname / IP</label>
            <input
              type="text"
              [(ngModel)]="editForm.hostname"
              placeholder="localhost or 192.168.1.100"
              class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
            />
          </div>

          <div>
            <label class="block text-sm text-zinc-400 mb-1.5">Connection Type</label>
            <select
              [(ngModel)]="editForm.connectionType"
              class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
            >
              @if (!isMobile()) {
                <option value="local">Local</option>
              }
              <option value="remote">Remote (SSH)</option>
            </select>
          </div>

          @if (editForm.connectionType === 'remote') {
            <div class="space-y-4 p-4 bg-zinc-800/50 rounded-lg">
              <div>
                <label class="block text-sm text-zinc-400 mb-1.5">SSH Username</label>
                <input
                  type="text"
                  [(ngModel)]="editForm.sshUsername"
                  placeholder="root"
                  class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                />
              </div>

              <div>
                <label class="block text-sm text-zinc-400 mb-1.5">SSH Port</label>
                <input
                  type="number"
                  [(ngModel)]="editForm.sshPort"
                  placeholder="22"
                  class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                />
              </div>

              <div>
                <label class="block text-sm text-zinc-400 mb-1.5">Auth Method</label>
                <select
                  [(ngModel)]="editForm.sshAuthMethod"
                  class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                >
                  <option value="password">Password</option>
                  <option value="publicKey">Public Key</option>
                </select>
              </div>

              @if (editForm.sshAuthMethod === 'password') {
                <div>
                  <label class="block text-sm text-zinc-400 mb-1.5">Password (leave empty to keep current)</label>
                  <input
                    type="password"
                    [(ngModel)]="editForm.sshPassword"
                    placeholder="SSH Password"
                    class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                  />
                </div>
              }

              @if (editForm.sshAuthMethod === 'publicKey') {
                <!-- Import Method Toggle -->
                <div>
                  <label class="block text-sm text-zinc-400 mb-1.5">Import Method</label>
                  <div class="flex gap-2">
                    <button
                      type="button"
                      (click)="editForm.sshKeyImportMethod = 'paste'"
                      class="flex-1 px-3 py-2 rounded-lg text-sm transition-colors"
                      [class.bg-blue-600]="editForm.sshKeyImportMethod === 'paste'"
                      [class.bg-zinc-700]="editForm.sshKeyImportMethod !== 'paste'"
                      [class.hover:bg-zinc-600]="editForm.sshKeyImportMethod !== 'paste'"
                    >
                      Paste Key
                    </button>
                    <button
                      type="button"
                      (click)="editForm.sshKeyImportMethod = 'file'"
                      class="flex-1 px-3 py-2 rounded-lg text-sm transition-colors"
                      [class.bg-blue-600]="editForm.sshKeyImportMethod === 'file'"
                      [class.bg-zinc-700]="editForm.sshKeyImportMethod !== 'file'"
                      [class.hover:bg-zinc-600]="editForm.sshKeyImportMethod !== 'file'"
                    >
                      Import File
                    </button>
                  </div>
                </div>

                @if (editForm.sshKeyImportMethod === 'paste') {
                  <!-- Paste Key Content -->
                  <div>
                    <label class="block text-sm text-zinc-400 mb-1.5">Private Key Content</label>
                    <textarea
                      [(ngModel)]="editForm.sshKeyContent"
                      placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"
                      rows="6"
                      class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm font-mono text-xs resize-y"
                    ></textarea>
                    <p class="text-xs text-zinc-500 mt-1">Paste your private key in PEM format (leave empty to keep current)</p>
                  </div>
                } @else {
                  <!-- Import from File -->
                  <div>
                    <label class="block text-sm text-zinc-400 mb-1.5">Private Key File</label>
                    @if (isMobile()) {
                      <!-- Mobile: Import file content -->
                      <button
                        type="button"
                        (click)="importKeyFromFile('edit')"
                        [disabled]="importingKey()"
                        class="w-full px-3 py-2.5 bg-zinc-700 hover:bg-zinc-600 border border-zinc-600 rounded-lg transition-colors flex items-center justify-center gap-2"
                      >
                        @if (importingKey()) {
                          <div class="w-4 h-4 border-2 border-zinc-400 border-t-white rounded-full animate-spin"></div>
                          <span>Importing...</span>
                        } @else {
                          <lucide-icon [img]="FolderOpen" class="w-4 h-4"></lucide-icon>
                          <span>Browse for Key File</span>
                        }
                      </button>
                      @if (editForm.sshKeyContent) {
                        <p class="text-xs text-green-500 mt-1 flex items-center gap-1">
                          <span>✓</span> Key imported/configured
                        </p>
                      }
                    } @else {
                      <!-- Desktop: File path or import -->
                      <div class="flex gap-2">
                        <input
                          type="text"
                          [(ngModel)]="editForm.sshKeyPath"
                          placeholder="~/.ssh/id_rsa"
                          class="flex-1 px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                        />
                        <button
                          type="button"
                          (click)="browseForSshKey('edit')"
                          title="Browse for SSH key"
                          class="px-3 py-2.5 sm:py-2 bg-zinc-700 hover:bg-zinc-600 border border-zinc-600 rounded-lg transition-colors"
                        >
                          <lucide-icon [img]="FolderOpen" class="w-4 h-4"></lucide-icon>
                        </button>
                      </div>
                    }
                  </div>
                }

                <div>
                  <label class="block text-sm text-zinc-400 mb-1.5">Key Passphrase (leave empty to keep current)</label>
                  <input
                    type="password"
                    [(ngModel)]="editForm.sshKeyPassphrase"
                    placeholder="Enter passphrase if key is encrypted"
                    class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
                  />
                </div>
              }
            </div>
          }

          <div>
            <label class="block text-sm text-zinc-400 mb-1.5">Primary Runtime</label>
            <select
              [(ngModel)]="editForm.primaryRuntime"
              class="w-full px-3 py-2.5 sm:py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-base sm:text-sm"
            >
              <option value="docker">Docker</option>
              <option value="podman">Podman</option>
              <option value="apple">Apple Container</option>
            </select>
          </div>

          <div class="flex items-center gap-3 py-1">
            <input
              type="checkbox"
              id="editAutoConnect"
              [(ngModel)]="editForm.autoConnect"
              class="w-5 h-5 rounded border-zinc-700"
            />
            <label for="editAutoConnect" class="text-sm text-zinc-400"
              >Auto-connect on app startup</label
            >
          </div>
        </div>
      </div>

      <!-- Footer (fixed) -->
      <div class="flex justify-end gap-3 px-4 sm:px-6 py-3 sm:py-4 border-t border-zinc-800 flex-shrink-0 safe-bottom">
        <button
          (click)="showEditDialog = false"
          class="px-4 py-2.5 sm:py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 transition-colors text-sm"
        >
          Cancel
        </button>
        <button
          (click)="updateSystem()"
          class="px-4 py-2.5 sm:py-2 rounded-lg bg-blue-600 hover:bg-blue-500 transition-colors text-sm"
          [disabled]="!editForm.name || !editForm.hostname"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
}
