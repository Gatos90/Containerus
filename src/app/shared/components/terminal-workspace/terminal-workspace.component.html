<div class="terminal-workspace">
  <!-- Main area with layout grid -->
  @if (!terminalState.isDockMinimized() && terminalState.hasDockedItems()) {
    <div
      class="workspace-grid"
      [class.single]="terminalState.layoutMode() === 'single'"
      [class.split-h]="terminalState.layoutMode() === 'split-h'"
      [class.split-v]="terminalState.layoutMode() === 'split-v'"
      [class.quad]="terminalState.layoutMode() === 'quad'"
    >
      @for (slot of terminalState.slots(); track trackByIndex($index)) {
        @let slotIdx = $index;
        <div
          class="terminal-slot"
          [class.active]="slotIdx === terminalState.activeSlotIndex()"
          [class.slot-drop-target]="slotDropTarget() === slotIdx"
          (click)="setActiveSlot(slotIdx)"
          (dragover)="onSlotDragOver($event, slotIdx)"
          (dragleave)="onSlotDragLeave($event)"
          (drop)="onSlotDrop($event, slotIdx)"
        >
          @if (getTerminalForSlot(slotIdx); as term) {
            <!-- Terminal: xterm container (hidden via CSS in warp mode) -->
            <div
              #terminalHost
              [attr.data-slot-index]="slotIdx"
              class="terminal-host"
              [class.hidden-for-warp]="term.displayMode === 'warp'"
              (click)="onTerminalHostClick(slotIdx, $event)"
            ></div>
            @if (term.displayMode === 'warp') {
              <div class="warp-overlay">
                <app-warp-terminal-view [terminalSessionId]="term.session.id"></app-warp-terminal-view>
              </div>
            }
          } @else if (getFileBrowserForSlot(slotIdx); as fb) {
            <!-- File browser in slot -->
            <div class="file-browser-slot-content">
              <app-file-browser-view
                [embeddedSystemId]="fb.systemId"
                [embeddedContainerId]="fb.containerId"
                [embeddedRuntime]="fb.runtime"
                [embeddedPath]="fb.currentPath"
              />
            </div>
          } @else {
            <!-- Empty slot with quick actions -->
            <div class="empty-slot-overlay">
              @if (systemState.connectedSystems().length > 0) {
                <div class="empty-slot-menu" (click)="$event.stopPropagation()">
                  <span class="text-zinc-500 text-[10px] uppercase tracking-wider mb-1">Open in slot {{ slotIdx + 1 }}</span>
                  <div class="empty-slot-scroll">
                    @for (sys of systemState.connectedSystems(); track sys.id) {
                      <!-- System row (click chevron to expand containers) -->
                      <div class="slot-menu-row">
                        @if (getRunningContainers(sys.id).length > 0) {
                          <button (click)="toggleSlotSystem(sys.id)" class="slot-menu-chevron">
                            <lucide-icon
                              [img]="expandedSlotSystemId() === sys.id ? ChevronDown : ChevronRight"
                              class="w-3 h-3"
                            ></lucide-icon>
                          </button>
                        }
                        <lucide-icon [img]="Server" class="w-3.5 h-3.5 text-zinc-400 flex-shrink-0"></lucide-icon>
                        <span class="truncate flex-1 text-xs text-zinc-200">{{ sys.name }}</span>
                        <button (click)="openNewTerminal(sys.id, slotIdx)" title="System Terminal" class="new-menu-icon-btn">
                          <lucide-icon [img]="TerminalIcon" class="w-3 h-3 text-green-400"></lucide-icon>
                        </button>
                        <button (click)="openNewFileBrowser(sys.id, slotIdx)" title="System Files" class="new-menu-icon-btn">
                          <lucide-icon [img]="FolderOpen" class="w-3 h-3 text-blue-400"></lucide-icon>
                        </button>
                      </div>
                      <!-- Containers (collapsible, indented) -->
                      @if (expandedSlotSystemId() === sys.id) {
                        @for (c of getRunningContainers(sys.id); track c.id) {
                          <div class="slot-menu-row slot-menu-indent">
                            <lucide-icon [img]="Box" class="w-3 h-3 text-emerald-400 flex-shrink-0"></lucide-icon>
                            <span class="truncate flex-1 text-xs text-zinc-400">{{ getDisplayName(c) }}</span>
                            <button (click)="openContainerTerminal(sys.id, c, slotIdx)" title="Terminal" class="new-menu-icon-btn">
                              <lucide-icon [img]="TerminalIcon" class="w-3 h-3 text-green-400"></lucide-icon>
                            </button>
                            <button (click)="openNewFileBrowser(sys.id, slotIdx, c.id, getDisplayName(c), c.runtime)" title="Files" class="new-menu-icon-btn">
                              <lucide-icon [img]="FolderOpen" class="w-3 h-3 text-blue-400"></lucide-icon>
                            </button>
                          </div>
                        }
                      }
                    }
                  </div>
                </div>
              } @else {
                <span class="text-zinc-500 text-sm">No systems connected</span>
              }
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Bottom dock bar -->
  <div class="dock-bar">
    <!-- Layout toggle buttons -->
    <div class="layout-controls">
      <button
        (click)="setLayout('single')"
        class="layout-btn"
        [class.active]="terminalState.layoutMode() === 'single'"
        title="Single view"
      >
        <lucide-icon [img]="Square" class="w-4 h-4"></lucide-icon>
      </button>
      <button
        (click)="setLayout('split-h')"
        class="layout-btn"
        [class.active]="terminalState.layoutMode() === 'split-h'"
        title="Split horizontal"
      >
        <lucide-icon [img]="Columns2" class="w-4 h-4"></lucide-icon>
      </button>
      <button
        (click)="setLayout('split-v')"
        class="layout-btn"
        [class.active]="terminalState.layoutMode() === 'split-v'"
        title="Split vertical"
      >
        <lucide-icon [img]="Rows2" class="w-4 h-4"></lucide-icon>
      </button>
      <button
        (click)="setLayout('quad')"
        class="layout-btn"
        [class.active]="terminalState.layoutMode() === 'quad'"
        title="Quad view"
      >
        <lucide-icon [img]="Grid2x2" class="w-4 h-4"></lucide-icon>
      </button>
    </div>

    <!-- Divider -->
    <div class="h-6 w-px bg-zinc-700"></div>

    <!-- New terminal button -->
    <div class="relative">
      <button
        (click)="toggleNewMenu()"
        class="layout-btn"
        title="New terminal"
      >
        <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon>
      </button>
      @if (showNewMenu()) {
        <div class="new-menu-popout">
          @for (sys of systemState.connectedSystems(); track sys.id) {
            <div class="new-menu-system-wrapper">
              <!-- System row: name + terminal/files icons + arrow for containers -->
              <div class="new-menu-system">
                <lucide-icon [img]="Server" class="w-3.5 h-3.5 text-zinc-400 flex-shrink-0"></lucide-icon>
                <span class="truncate flex-1">{{ sys.name }}</span>
                <button (click)="openNewTerminal(sys.id)" title="System Terminal" class="new-menu-icon-btn">
                  <lucide-icon [img]="TerminalIcon" class="w-3 h-3 text-green-400"></lucide-icon>
                </button>
                <button (click)="openNewFileBrowser(sys.id)" title="System Files" class="new-menu-icon-btn">
                  <lucide-icon [img]="FolderOpen" class="w-3 h-3 text-blue-400"></lucide-icon>
                </button>
                @if (getRunningContainers(sys.id).length > 0) {
                  <lucide-icon [img]="ChevronRight" class="w-3 h-3 text-zinc-500 flex-shrink-0"></lucide-icon>
                }
              </div>

              <!-- Container sub-menu (appears on hover to the right) -->
              @if (getRunningContainers(sys.id).length > 0) {
                <div class="new-menu-submenu">
                  @for (container of getRunningContainers(sys.id); track container.id) {
                    @if (!$first) {
                      <div class="new-menu-divider"></div>
                    }
                    <div class="new-menu-container-row">
                      <lucide-icon [img]="Box" class="w-3 h-3 text-emerald-400 flex-shrink-0"></lucide-icon>
                      <span class="truncate flex-1">{{ getDisplayName(container) }}</span>
                      <button (click)="openContainerTerminal(sys.id, container)" title="Terminal" class="new-menu-icon-btn">
                        <lucide-icon [img]="TerminalIcon" class="w-3 h-3 text-green-400"></lucide-icon>
                      </button>
                      <button (click)="openNewFileBrowser(sys.id, undefined, container.id, getDisplayName(container), container.runtime)" title="Files" class="new-menu-icon-btn">
                        <lucide-icon [img]="FolderOpen" class="w-3 h-3 text-blue-400"></lucide-icon>
                      </button>
                    </div>
                  }
                </div>
              }
            </div>
          }
          @if (systemState.connectedSystems().length === 0) {
            <div class="new-menu-empty">No systems connected</div>
          }
        </div>
      }
    </div>

    <!-- Divider -->
    <div class="h-6 w-px bg-zinc-700"></div>

    <!-- Terminal tabs -->
    <div class="terminal-tabs">
      @for (term of terminalState.dockedTerminals(); track trackByTerminalId($index, term)) {
        <div
          class="terminal-tab"
          [class.active]="isTerminalInSlot(term.id)"
          [class.drag-over]="dropTargetIndex() === $index && dragTabType() === 'terminal'"
          [class.dragging]="dragTabIndex() === $index && dragTabType() === 'terminal'"
          (click)="focusTerminal(term.id)"
          draggable="true"
          (dragstart)="onTabDragStart($index, 'terminal', term.id); $event.dataTransfer?.setData('text/plain', term.id)"
          (dragover)="onTabDragOver($event, $index, 'terminal')"
          (dragleave)="onTabDragLeave($event)"
          (drop)="onTabDrop($event, $index, 'terminal')"
          (dragend)="onTabDragEnd()"
        >
          @if (isSplitView() && getSlotIndex(term.id) >= 0) {
            <span class="slot-badge">{{ getSlotIndex(term.id) + 1 }}</span>
          }
          <span class="truncate">{{ term.systemName }}</span>
          @if (term.containerName) {
            <span class="text-xs text-zinc-500 truncate">/{{ term.containerName }}</span>
          }
          <button
            class="close-btn"
            (click)="closeTerminal(term.id, $event)"
            title="Close terminal"
          >
            <lucide-icon [img]="X" class="w-3 h-3"></lucide-icon>
          </button>
        </div>
      }
      @for (fb of terminalState.dockedFileBrowsers(); track trackByFileBrowserId($index, fb)) {
        <div
          class="terminal-tab"
          [class.active]="isFileBrowserInSlot(fb.id)"
          [class.drag-over]="dropTargetIndex() === $index && dragTabType() === 'file-browser'"
          [class.dragging]="dragTabIndex() === $index && dragTabType() === 'file-browser'"
          (click)="openFileBrowser(fb)"
          draggable="true"
          (dragstart)="onTabDragStart($index, 'file-browser', fb.id); $event.dataTransfer?.setData('text/plain', fb.id)"
          (dragover)="onTabDragOver($event, $index, 'file-browser')"
          (dragleave)="onTabDragLeave($event)"
          (drop)="onTabDrop($event, $index, 'file-browser')"
          (dragend)="onTabDragEnd()"
        >
          @if (isSplitView() && getFileBrowserSlotIndex(fb.id) >= 0) {
            <span class="slot-badge">{{ getFileBrowserSlotIndex(fb.id) + 1 }}</span>
          }
          <lucide-icon [img]="FolderOpen" class="w-3.5 h-3.5 text-blue-400 flex-shrink-0"></lucide-icon>
          <span class="truncate">{{ fb.systemName }}</span>
          @if (fb.containerName) {
            <span class="text-xs text-zinc-500 truncate">/{{ fb.containerName }}</span>
          }
          <button
            class="close-btn"
            (click)="closeFileBrowser(fb.id, $event)"
            title="Remove from dock"
          >
            <lucide-icon [img]="X" class="w-3 h-3"></lucide-icon>
          </button>
        </div>
      }
      @if (terminalState.dockedTerminals().length === 0 && terminalState.dockedFileBrowsers().length === 0) {
        <span class="text-zinc-500 text-xs px-2">No items docked</span>
      }
    </div>

    <!-- Warp/xterm toggle button -->
    <button
      (click)="toggleTerminalMode(terminalState.activeTerminal()?.id)"
      class="layout-btn"
      [class.active]="terminalState.activeTerminal()?.displayMode === 'warp'"
      [disabled]="!terminalState.activeTerminal()"
      title="Toggle Warp/xterm view"
    >
      <lucide-icon [img]="Sparkles" class="w-4 h-4"></lucide-icon>
    </button>

    <!-- Keyboard shortcuts -->
    <div class="relative">
      <button
        (click)="toggleShortcuts()"
        class="layout-btn"
        title="Keyboard shortcuts"
      >
        <lucide-icon [img]="Keyboard" class="w-4 h-4"></lucide-icon>
      </button>
      @if (showShortcuts()) {
        <div class="absolute bottom-full right-0 mb-1 bg-zinc-800 border border-zinc-700 rounded-lg shadow-xl p-3 min-w-[220px] z-50">
          <div class="text-xs font-medium text-zinc-300 mb-2">Keyboard Shortcuts</div>
          <div class="space-y-1.5 text-xs">
            <div class="flex justify-between gap-4">
              <span class="text-zinc-400">Switch tab 1-9</span>
              <kbd class="text-zinc-300 bg-zinc-700 px-1.5 py-0.5 rounded font-mono">Ctrl+1-9</kbd>
            </div>
            <div class="flex justify-between gap-4">
              <span class="text-zinc-400">Toggle fullscreen</span>
              <kbd class="text-zinc-300 bg-zinc-700 px-1.5 py-0.5 rounded font-mono">Ctrl+Shift+F</kbd>
            </div>
            <div class="flex justify-between gap-4">
              <span class="text-zinc-400">Toggle minimize</span>
              <kbd class="text-zinc-300 bg-zinc-700 px-1.5 py-0.5 rounded font-mono">Ctrl+Shift+M</kbd>
            </div>
            <div class="flex justify-between gap-4">
              <span class="text-zinc-400">Command palette</span>
              <kbd class="text-zinc-300 bg-zinc-700 px-1.5 py-0.5 rounded font-mono">Ctrl+K</kbd>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Divider -->
    <div class="h-6 w-px bg-zinc-700"></div>

    <!-- Fullscreen button -->
    <button
      (click)="toggleDockFullscreen()"
      class="minimize-btn"
      title="Toggle fullscreen"
    >
      <lucide-icon
        [img]="terminalState.isDockFullscreen() ? Minimize2 : Maximize2"
        class="w-4 h-4"
      ></lucide-icon>
    </button>

    <!-- Minimize dock button -->
    <button
      (click)="toggleDockMinimized()"
      class="minimize-btn"
      title="Toggle workspace"
    >
      <lucide-icon
        [img]="terminalState.isDockMinimized() ? ChevronUp : ChevronDown"
        class="w-4 h-4"
      ></lucide-icon>
    </button>
  </div>
</div>
